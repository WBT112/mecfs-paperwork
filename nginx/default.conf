map $uri $cache_control {
  =/index.html "no-cache, must-revalidate";
  ~^/formpacks($|/) "no-cache, must-revalidate";
  default "no-cache, must-revalidate";
  ~^/assets/ "public, max-age=31536000, immutable";
}

server {
  listen 8080;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # ------------------------------------------------------------
  # Health check endpoint
  # ------------------------------------------------------------
  location = /health {
    access_log off;
    default_type text/plain;
    return 200 'OK';
  }

  # ------------------------------------------------------------
  # Build assets: hashed files can be cached long-term
  # ------------------------------------------------------------
  location /assets/ {
    try_files $uri =404;
  }

  # ------------------------------------------------------------
  # SPA Deep Links for Formpack UI
  #
  # We have both:
  # - SPA routes: /formpacks and /formpacks/:id
  # - Static assets: /formpacks/:id/manifest.json etc.
  #
  # The deep links must fall back to /index.html, while asset files
  # must remain static with 404 on missing files.
  # ------------------------------------------------------------

  # List page route: /formpacks
  location = /formpacks {
    try_files /index.html =404;
  }

  # Static formpack assets (manifest/schema/ui.schema/i18n/templates/...)
  location ~* ^/formpacks/.*\.(json|docx|xml|md|txt|png|svg|webmanifest)$ {
    try_files $uri =404;
  }

  # Everything else below /formpacks/* is a SPA route and must resolve to index.
  location /formpacks/ {
    try_files /index.html =404;
  }

  # ------------------------------------------------------------
  # SPA fallback: everything else
  # ------------------------------------------------------------
  location / {
    try_files $uri /index.html;
  }

  # ------------------------------------------------------------
  # Security headers + caching policy
  # ------------------------------------------------------------
  add_header Cache-Control $cache_control always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header Content-Security-Policy "default-src 'self' blob:; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self' data:;" always;
}
