name: SBOM

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sbom:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Check DHI secrets
        id: check-secrets
        env:
          DHI_USERNAME: ${{ secrets.DHI_USERNAME }}
          DHI_TOKEN: ${{ secrets.DHI_TOKEN }}
        run: |
          if [ -n "$DHI_USERNAME" ] && [ -n "$DHI_TOKEN" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Notice (PRs without secrets)
        if: steps.check-secrets.outputs.available != 'true' && github.event_name == 'pull_request'
        run: |
          echo "::notice::Skipping container image SBOM because DHI registry credentials are not available on pull_request events."

      - name: Notice (events without secrets)
        if: steps.check-secrets.outputs.available != 'true' && github.event_name != 'pull_request'
        run: |
          echo "::notice::Skipping container image SBOM because DHI registry credentials are not available."

      - name: Login to DHI registry
        if: steps.check-secrets.outputs.available == 'true'
        timeout-minutes: 5
        env:
          DHI_USERNAME: ${{ secrets.DHI_USERNAME }}
          DHI_TOKEN: ${{ secrets.DHI_TOKEN }}
        run: |
          for attempt in 1 2 3; do
            if echo "$DHI_TOKEN" | docker login dhi.io -u "$DHI_USERNAME" --password-stdin; then
              exit 0
            fi

            echo "Login attempt ${attempt} failed. Retrying in 5s..."
            sleep 5
          done

          echo "Registry login failed after 3 attempts."
          exit 1

      - name: Build container image
        if: steps.check-secrets.outputs.available == 'true'
        run: docker build --pull -t mecfs-paperwork:${{ github.sha }} .

      - name: Generate workspace SBOM (CycloneDX)
        uses: anchore/sbom-action@v0.15.11
        with:
          path: .
          format: cyclonedx-json
          output-file: sbom.workspace.cdx.json
          upload-artifact: false

      - name: Generate workspace SBOM (SPDX)
        uses: anchore/sbom-action@v0.15.11
        with:
          path: .
          format: spdx-json
          output-file: sbom.workspace.spdx.json
          upload-artifact: false

      - name: Generate image SBOM (CycloneDX)
        if: steps.check-secrets.outputs.available == 'true'
        uses: anchore/sbom-action@v0.15.11
        with:
          image: mecfs-paperwork:${{ github.sha }}
          format: cyclonedx-json
          output-file: sbom.image.cdx.json
          upload-artifact: false

      - name: Generate image SBOM (SPDX)
        if: steps.check-secrets.outputs.available == 'true'
        uses: anchore/sbom-action@v0.15.11
        with:
          image: mecfs-paperwork:${{ github.sha }}
          format: spdx-json
          output-file: sbom.image.spdx.json
          upload-artifact: false

      - name: Build SBOM summary
        run: |
          set -euo pipefail
          SUMMARY_ARGS=(
            --input sbom.workspace.cdx.json
            --input sbom.workspace.spdx.json
            --output sbom-summary.md
          )
          if [ "${{ steps.check-secrets.outputs.available }}" = "true" ]; then
            SUMMARY_ARGS+=(--input sbom.image.cdx.json --input sbom.image.spdx.json)
          fi
          node tools/sbom-summary.mjs "${SUMMARY_ARGS[@]}"

      - name: Publish SBOM summary
        run: cat sbom-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Grype scan (workspace SBOM)
        uses: anchore/scan-action@v6
        with:
          sbom: sbom.workspace.cdx.json
          output-format: json
          output-file: grype-workspace.json
          fail-build: false

      - name: Summarize Grype results
        run: node tools/grype-summary.mjs --input grype-workspace.json --output grype-summary.md

      - name: Publish Grype summary
        run: cat grype-summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload SBOM artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: sbom-workspace
          path: |
            sbom.workspace.cdx.json
            sbom.workspace.spdx.json
            sbom-summary.md
            grype-workspace.json
            grype-summary.md
          retention-days: 14

      - name: Upload image SBOM artifacts
        if: always() && steps.check-secrets.outputs.available == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: sbom-image
          path: |
            sbom.image.cdx.json
            sbom.image.spdx.json
          retention-days: 14

      - name: Cleanup image artifacts
        if: always() && steps.check-secrets.outputs.available == 'true'
        run: docker image rm mecfs-paperwork:${{ github.sha }} || true
