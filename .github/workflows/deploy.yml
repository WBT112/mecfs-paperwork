name: Build & Deploy (Docker Hub + Server)

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    types: [closed]
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment target"
        required: true
        type: choice
        options:
          - staging
          - prod
      ref:
        description: "Optional git ref (branch or SHA) to build"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'staging'))

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false
          ref: ${{ inputs.ref || github.event.pull_request.merge_commit_sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine build configuration
        id: config
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            base_ref="${{ inputs.environment }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.event.pull_request.base.ref }}"
          else
            base_ref="${GITHUB_REF#refs/heads/}"
          fi

          if [ "$base_ref" = "main" ] || [ "$base_ref" = "prod" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "vite_mode=production" >> $GITHUB_OUTPUT
            echo "show_dev_formpacks=" >> $GITHUB_OUTPUT
            echo "deployment_env=production" >> $GITHUB_OUTPUT
            echo "public_origin=https://mecfs-paperwork.de" >> $GITHUB_OUTPUT
            echo "tag_env=prod" >> $GITHUB_OUTPUT
          elif [ "$base_ref" = "staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "vite_mode=staging" >> $GITHUB_OUTPUT
            echo "show_dev_formpacks=true" >> $GITHUB_OUTPUT
            echo "deployment_env=staging" >> $GITHUB_OUTPUT
            echo "public_origin=https://staging.mecfs-paperwork.de" >> $GITHUB_OUTPUT
            echo "tag_env=staging" >> $GITHUB_OUTPUT
          else
            echo "Unknown branch"
            exit 1
          fi

      - name: Extract commit SHA (short)
        id: sha
        run: echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Capture build metadata
        id: build_meta
        run: echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          push: true
          tags: |
            wbt112/mecfs-paperwork:${{ steps.config.outputs.tag_env }}
            wbt112/mecfs-paperwork:${{ steps.config.outputs.tag_env }}-${{ steps.sha.outputs.short }}
          build-args: |
            VITE_MODE=${{ steps.config.outputs.vite_mode }}
            VITE_SHOW_DEV_FORMPACKS=${{ steps.config.outputs.show_dev_formpacks }}
            VITE_DEPLOYMENT_ENV=${{ steps.config.outputs.deployment_env }}
            VITE_PUBLIC_ORIGIN=${{ steps.config.outputs.public_origin }}
            VITE_APP_VERSION=${{ steps.sha.outputs.short }}
            VITE_BUILD_DATE=${{ steps.build_meta.outputs.date }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image digest
        run: echo "Image pushed successfully with tags ${{ steps.config.outputs.tag_env }} and ${{ steps.config.outputs.tag_env }}-${{ steps.sha.outputs.short }}"

  deploy:
    name: Deploy to Server
    needs: build-and-push
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-${{ github.event_name == 'workflow_dispatch' && inputs.environment || github.ref_name }}
      cancel-in-progress: false
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')) ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true && (github.event.pull_request.base.ref == 'main' || github.event.pull_request.base.ref == 'staging'))

    steps:
      - name: Checkout code (for compose file)
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          persist-credentials: false
          ref: ${{ inputs.ref || github.event.pull_request.merge_commit_sha || github.sha }}

      - name: Deploy to server via SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          SSH_HOST: ${{ secrets.DEPLOY_HOST }}
          SSH_USER: ${{ secrets.DEPLOY_USER }}
          SSH_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail

          retry() {
            local attempts="$1"
            shift
            local n=1
            until "$@"; do
              if [ "$n" -ge "$attempts" ]; then
                return 1
              fi
              sleep $((2 * n))
              n=$((n + 1))
            done
          }

          # Setup SSH
          mkdir -p ~/.ssh
          key_written=false
          if printf '%s' "$SSH_PRIVATE_KEY" | base64 -d 2>/dev/null | tr -d '\r' > ~/.ssh/deploy_key.tmp; then
            if grep -q -- "-----BEGIN" ~/.ssh/deploy_key.tmp; then
              mv ~/.ssh/deploy_key.tmp ~/.ssh/deploy_key
              key_written=true
            fi
          fi
          rm -f ~/.ssh/deploy_key.tmp
          if [ "$key_written" = false ]; then
            cat <<<"$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/deploy_key
            if grep -q -- "-----BEGIN" ~/.ssh/deploy_key; then
              key_written=true
            else
              rm -f ~/.ssh/deploy_key
            fi
          fi
          if [ "$key_written" = false ]; then
            echo "::error::SSH_PRIVATE_KEY must be a PEM key or base64-encoded PEM."
            exit 1
          fi
          chmod 600 ~/.ssh/deploy_key
          if ! ssh-keygen -y -f ~/.ssh/deploy_key >/dev/null 2>&1; then
            echo "::error::SSH_PRIVATE_KEY is invalid or corrupted."
            exit 1
          fi

          if [ -n "${SSH_KNOWN_HOSTS:-}" ]; then
            printf '%s\n' "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          else
            retry 5 ssh-keyscan -T 10 -H -t ed25519,ecdsa "$SSH_HOST" > ~/.ssh/known_hosts
          fi
          chmod 600 ~/.ssh/known_hosts

          SSH_OPTS="-i ~/.ssh/deploy_key -o BatchMode=yes -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes -o ConnectTimeout=20 -o ConnectionAttempts=3 -o ServerAliveInterval=15 -o ServerAliveCountMax=3"

          # Copy deployment files to server
          retry 5 scp $SSH_OPTS compose.deploy.yaml Caddyfile "$SSH_USER@$SSH_HOST:/opt/mecfs-paperwork/"

          # Execute deployment commands on server
          retry 5 ssh $SSH_OPTS "$SSH_USER@$SSH_HOST" \
            "cd /opt/mecfs-paperwork && \
             echo '$DOCKERHUB_TOKEN' | docker login -u '$DOCKERHUB_USERNAME' --password-stdin && \
             docker compose -f compose.deploy.yaml pull && \
             docker compose -f compose.deploy.yaml up -d && \
             docker image prune -af --filter 'until=168h'"
