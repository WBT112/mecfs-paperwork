# Internationalization (i18n)

## App UI strings

- Base app translations live in `app/src/i18n/resources/de.json` and `en.json`.
- Use the `app` namespace with `react-i18next` (default namespace).
- Supported locales: `de` (default) and `en` (fallback).
- Configuration: `app/src/i18n/index.ts` initializes i18next with `react-i18next`.

## Locale persistence

- The UI locale is stored in `localStorage` under the key `mecfs-paperwork.locale`.
- If storage is unavailable, the app falls back to the default locale (`de`).
- Locale utilities: `app/src/i18n/locale.ts` exports `supportedLocales`, `defaultLocale`, `getStoredLocale()`, `setStoredLocale()`.

## Formpack translations

Formpack translations are shipped as static JSON files in `app/public/formpacks/<id>/i18n/`.

Expected runtime path:

```
/formpacks/<formpackId>/i18n/<locale>.json
```

**File format:** Flat JSON (not nested), all keys at the top level, namespaced by formpack ID:

```json
{
  "doctor-letter.title": "ICD-10 Brief",
  "doctor-letter.section.patient.title": "Patient",
  "doctor-letter.patient.firstName.label": "Vorname"
}
```

**Key naming conventions:**

| Pattern                                | Purpose                             |
| -------------------------------------- | ----------------------------------- |
| `<id>.title`                           | Pack title                          |
| `<id>.description`                     | Pack description                    |
| `<id>.section.<section>.title`         | Section heading                     |
| `<id>.<section>.<field>.label`         | Field label                         |
| `<id>.<section>.<field>.help`          | Field help text                     |
| `<id>.common.yes` / `<id>.common.no`   | Reusable enum labels                |
| `<id>.<section>.<field>.option.<name>` | Enum option label                   |
| `<id>.case.<n>.paragraph`              | Decision case text                  |
| `<id>.infobox.<field>`                 | InfoBox content (supports markdown) |

**Paragraph markers:** Use `[[P]]` for paragraph breaks and `[[BR]]` for line breaks within export text values.

**Loading behavior:**

1. The app attempts to load the requested locale.
2. If missing, it tries the default locale (`de`).
3. If still missing, it falls back to English (`en`).
4. If none are available, no translations are registered and the app continues.

Formpack translations are registered in i18next under the namespace `formpack:<formpackId>`.

Loading is handled by `loadFormpackI18n()` in `app/src/i18n/formpack.ts`, which caches loaded bundles to avoid redundant fetches.

## UI schema translation

The `translateUiSchema()` function in `app/src/i18n/rjsf.ts` translates values for `ui:title`, `ui:description`, `ui:help`, and `ui:enumNames` in RJSF UI schemas.

A value is detected as a translation key if it either:

- starts with the `t:` prefix (e.g., `t:doctor-letter.patient.firstName.label`), or
- contains a `.`, has no whitespace, and is non-empty (auto-detection).

In practice, formpack UI schemas use bare keys without the `t:` prefix.

## Adding a new locale

To add a new locale (e.g., `fr`):

1. **App strings:** Create `app/src/i18n/resources/fr.json` with the same key set as `de.json`.
2. **Locale config:** Add `'fr'` to the `supportedLocales` array in `app/src/i18n/locale.ts`.
3. **i18n init:** Add the new resource bundle in `app/src/i18n/index.ts` (`resources.fr: { app: fr }`).
4. **Formpack translations:** For each formpack, create `app/public/formpacks/<id>/i18n/fr.json` with the same keys as `de.json`.
5. **Locale manifest:** Add `'fr'` to the `locales` array in each formpack's `manifest.json`.
6. **Language switcher:** Update the UI language selector component to include the new locale.
7. **User-facing content:** Add translated help (`app/src/content/help/help.fr.md`) and legal content if applicable.

Both `de.json` and `en.json` must have identical key sets for each formpack. The formpack validation command (`npm run formpack:validate`) checks this contract.

## Key source files

| File                             | Purpose                                   |
| -------------------------------- | ----------------------------------------- |
| `app/src/i18n/locale.ts`         | Supported locales, storage, validation    |
| `app/src/i18n/index.ts`          | i18next initialization with react-i18next |
| `app/src/i18n/formpack.ts`       | Formpack translation loading and caching  |
| `app/src/i18n/rjsf.ts`           | UI schema translation (auto-detects keys) |
| `app/src/i18n/useLocale.ts`      | React hook for current locale             |
| `app/src/i18n/resources/de.json` | German app UI strings                     |
| `app/src/i18n/resources/en.json` | English app UI strings                    |
